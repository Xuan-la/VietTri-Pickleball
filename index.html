<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω CLB Pickleball - Firebase</title>
    <style>
        :root {
            --color-primary: #208791;
            --color-primary-hover: #186e7e;
            --color-primary-active: #157170;
            --color-text: #134252;
            --color-text-secondary: #626c7c;
            --color-bg: #fcfcf9;
            --color-surface: #fffffe;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-success: #22c75a;
            --color-error: #c0152f;
            --color-warning: #a84b2f;
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            padding: 16px;
            line-height: 1.5;
        }

        .container { max-width: 700px; margin: 0 auto; }
        header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--color-primary);
        }

        header h1 { font-size: 24px; color: var(--color-primary); margin-bottom: 4px; }
        header p { color: var(--color-text-secondary); font-size: 14px; }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(34, 199, 90, 0.1);
            border: 1px solid rgba(34, 199, 90, 0.3);
            border-radius: var(--radius);
            margin-bottom: 16px;
            font-size: 12px;
            color: #1a8a3a;
        }

        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c75a;
        }

        .sync-status.loading {
            background: rgba(168, 75, 47, 0.1);
            border-color: rgba(168, 75, 47, 0.3);
            color: #a84b2f;
        }

        .sync-status.loading .sync-indicator {
            background: #a84b2f;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--color-border);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 150ms;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 16px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--color-text);
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            color: var(--color-text);
            background: var(--color-surface);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(32, 135, 145, 0.15);
        }

        .btn {
            width: 100%;
            padding: 12px 16px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 150ms;
            margin-top: 8px;
        }

        .btn:hover { background: var(--color-primary-hover); }
        .btn.success { background: var(--color-success); }
        .btn.success:hover { background: #1a8a3a; }
        .btn.danger { background: var(--color-error); }
        .btn.danger:hover { background: #a0121f; }
        .btn.warning { background: var(--color-warning); }
        .btn.warning:hover { background: #974325; }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .row .form-group { margin-bottom: 0; }

        .member-list { margin-top: 16px; }
        .member-item {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .member-name { font-weight: 600; }
        .member-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(32, 135, 145, 0.1);
            color: var(--color-primary);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .member-badge.guest {
            background: rgba(165, 75, 47, 0.1);
            color: #a84b2f;
        }

        .delete-btn {
            background: var(--color-error);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 150ms;
        }

        .delete-btn:hover { background: #a0121f; }

        .match-item {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .match-info { flex: 1; }
        .match-players { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
        .match-score { font-size: 12px; color: var(--color-text-secondary); }

        .payment-item {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-name { font-weight: 600; font-size: 16px; }
        .money {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .money.positive { color: var(--color-success); }
        .money.negative { color: var(--color-error); }

        .total-payment {
            background: rgba(32, 135, 145, 0.1);
            border: 2px solid var(--color-primary);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
            margin-top: 20px;
        }

        .total-payment-label { font-size: 14px; color: var(--color-text-secondary); margin-bottom: 8px; }
        .total-payment-value { font-size: 32px; font-weight: 700; color: var(--color-primary); font-family: 'Courier New', monospace; }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            border-radius: var(--radius);
            overflow: hidden;
        }

        .ranking-table thead {
            background: var(--color-primary);
            color: white;
        }

        .ranking-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .ranking-table td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
            font-size: 14px;
        }

        .ranking-table tbody tr:hover { background: rgba(32, 135, 145, 0.05); }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            font-weight: 600;
            font-size: 14px;
        }

        .rank-1 { background: #ffd700; color: #333; }
        .rank-2 { background: #c0c0c0; color: #333; }
        .rank-3 { background: #cd7f32; color: white; }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-secondary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: var(--radius);
            color: white;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
        }

        .notification.success { background: var(--color-success); }
        .notification.error { background: var(--color-error); }
        .notification.info { background: var(--color-primary); }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        h2 { font-size: 18px; margin-top: 16px; margin-bottom: 12px; color: var(--color-text); }
        h3 { font-size: 14px; margin: 16px 0 8px 0; color: var(--color-text); }

        .payment-date-header {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 16px 0 12px 0;
        }

        .info-text { font-size: 12px; color: var(--color-text-secondary); margin-top: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèì Qu·∫£n L√Ω CLB Pickleball</h1>
            <p>T√≠nh ti·ªÅn + Firebase Cloud Sync</p>
        </header>

        <div class="sync-status" id="syncStatus">
            <span class="sync-indicator"></span>
            <span id="syncText">S·∫µn s√†ng ƒë·ªìng b·ªô</span>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'members')">üë• VƒêV</button>
            <button class="tab-btn" onclick="switchTab(event, 'schedule')">üìÖ L·ªãch</button>
            <button class="tab-btn" onclick="switchTab(event, 'matches')">üéæ Tr·∫≠n</button>
            <button class="tab-btn" onclick="switchTab(event, 'payment')">üí≥ Ti·ªÅn</button>
            <button class="tab-btn" onclick="switchTab(event, 'ranking-money')">üí∞ BXH Ti·ªÅn</button>
            <button class="tab-btn" onclick="switchTab(event, 'ranking-skill')">‚≠ê BXH Tr√¨nh</button>
            <button class="tab-btn" onclick="switchTab(event, 'ranking-score')">üèÜ BXH ƒêi·ªÉm</button>
            <button class="tab-btn" onclick="switchTab(event, 'backup')">üíæ Backup</button>
            <button class="tab-btn" onclick="switchTab(event, 'settings')">üîê C√†i ƒê·∫∑t</button>
        </div>

        <!-- Tab VƒêV -->
        <div id="members" class="tab-content active">
            <h2>‚ûï Th√™m Th√†nh Vi√™n/Kh√°ch</h2>
            <div class="row">
                <div class="form-group">
                    <label>T√™n VƒêV</label>
                    <input type="text" id="memberName" placeholder="Nh·∫≠p t√™n">
                </div>
                <div class="form-group">
                    <label>Lo·∫°i</label>
                    <select id="memberType">
                        <option value="club">Th√†nh Vi√™n CLB</option>
                        <option value="guest">Kh√°ch</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="addMember()">‚ûï Th√™m VƒêV</button>

            <h2>üë• Danh S√°ch Th√†nh Vi√™n</h2>
            <div class="member-list" id="membersList"></div>
        </div>

        <!-- Tab L·ªãch Sinh Ho·∫°t -->
        <div id="schedule" class="tab-content">
            <h2>üìÖ Th√™m L·ªãch Sinh Ho·∫°t</h2>
            <div class="row">
                <div class="form-group">
                    <label>Ng√†y Sinh Ho·∫°t (dd/mm/yyyy)</label>
                    <input type="text" id="scheduleDate" placeholder="01/12/2025">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Ghi Ch√∫ (t√πy ch·ªçn)</label>
                    <input type="text" id="scheduleNote" placeholder="V√≠ d·ª•: V√≤ng 1, B√°n k·∫øt...">
                </div>
            </div>
            <button class="btn" onclick="addSchedule()">üìÖ Th√™m Ng√†y</button>

            <h2>Danh S√°ch L·ªãch Sinh Ho·∫°t</h2>
            <div class="member-list" id="scheduleList"></div>
        </div>

        <!-- Tab Tr·∫≠n ƒê·∫•u -->
        <div id="matches" class="tab-content">
            <h2>üéæ Ghi L·∫°i Tr·∫≠n ƒê·∫•u</h2>
            <div class="form-group">
                <label>Ch·ªçn Ng√†y Sinh Ho·∫°t</label>
                <select id="eventDate" onchange="updateMatchForm()">
                    <option value="">-- Ch·ªçn ng√†y --</option>
                </select>
            </div>

            <h3>C·∫∑p 1</h3>
            <div class="row">
                <div class="form-group">
                    <label>VƒêV 1</label>
                    <select id="pair1a">
                        <option value="">-- Ch·ªçn --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>VƒêV 2</label>
                    <select id="pair1b">
                        <option value="">-- Ch·ªçn --</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>T·ª∑ S·ªë</label>
                <input type="number" id="score1" placeholder="15" min="0">
            </div>

            <h3>C·∫∑p 2</h3>
            <div class="row">
                <div class="form-group">
                    <label>VƒêV 1</label>
                    <select id="pair2a">
                        <option value="">-- Ch·ªçn --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>VƒêV 2</label>
                    <select id="pair2b">
                        <option value="">-- Ch·ªçn --</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>T·ª∑ S·ªë</label>
                <input type="number" id="score2" placeholder="10" min="0">
            </div>

            <button class="btn" onclick="addMatch()">‚ûï Th√™m Tr·∫≠n ƒê·∫•u</button>

            <h2>Danh S√°ch Tr·∫≠n ƒê·∫•u</h2>
            <div class="member-list" id="matchList"></div>
        </div>

        <!-- Tab T√≠nh Ti·ªÅn -->
        <div id="payment" class="tab-content">
            <h2>üí≥ B·∫£ng T√≠nh Ti·ªÅn</h2>
            <div class="form-group">
                <label>Ch·ªçn Ng√†y Sinh Ho·∫°t</label>
                <select id="paymentDate" onchange="updatePaymentList()">
                    <option value="">-- Ch·ªçn ng√†y --</option>
                </select>
            </div>
            <div id="paymentList"></div>
        </div>

        <!-- Tab BXH Ti·ªÅn -->
        <div id="ranking-money" class="tab-content">
            <h2>üí∞ B·∫£ng X·∫øp H·∫°ng Ti·ªÅn (NƒÉm D∆∞∆°ng L·ªãch)</h2>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>H·∫°ng</th>
                        <th>T√™n VƒêV</th>
                        <th>Tr·∫≠n</th>
                        <th>Ti·ªÅn (k)</th>
                    </tr>
                </thead>
                <tbody id="rankingMoneyBody">
                    <tr>
                        <td colspan="4" class="empty-state" style="padding: 40px 20px;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Tab BXH Tr√¨nh ƒê·ªô -->
        <div id="ranking-skill" class="tab-content">
            <h2>‚≠ê B·∫£ng X·∫øp H·∫°ng Tr√¨nh ƒê·ªô (‚â•5 Tr·∫≠n)</h2>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>H·∫°ng</th>
                        <th>T√™n VƒêV</th>
                        <th>Tr·∫≠n</th>
                        <th>Th·∫Øng %</th>
                    </tr>
                </thead>
                <tbody id="rankingSkillBody">
                    <tr>
                        <td colspan="4" class="empty-state" style="padding: 40px 20px;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Tab BXH ƒêi·ªÉm S·ªë -->
        <div id="ranking-score" class="tab-content">
            <h2>üèÜ B·∫£ng X·∫øp H·∫°ng ƒêi·ªÉm S·ªë</h2>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>H·∫°ng</th>
                        <th>T√™n VƒêV</th>
                        <th>W/L</th>
                        <th>ƒêi·ªÉm</th>
                        <th>Hi·ªáu S·ªë</th>
                    </tr>
                </thead>
                <tbody id="rankingScoreBody">
                    <tr>
                        <td colspan="5" class="empty-state" style="padding: 40px 20px;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Tab C√†i ƒê·∫∑t -->
        <div id="settings" class="tab-content">
            <h2>üîê C√†i ƒê·∫∑t B·∫£o M·∫≠t</h2>
            <div class="form-group">
                <label>
                    <strong>‚ö†Ô∏è Ch·∫ø ƒê·ªô Xem (Ch·ªâ ƒê·ªçc) - Lu√¥n B·∫≠t</strong>
                </label>
                <p class="info-text" style="margin-top: 8px;">Ch·∫ø ƒë·ªô xem lu√¥n b·∫≠t. Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ t·∫°m t·∫Øt trong 5 ph√∫t.</p>
                <button class="btn warning" onclick="toggleReadOnlyWithPassword()">üîì T·∫Øt Ch·∫ø ƒê·ªô Xem (5 ph√∫t)</button>
            </div>

            <div class="info-text" style="margin-top: 20px; background: rgba(192, 21, 47, 0.1); padding: 12px; border-radius: 8px;">
                ‚ö†Ô∏è <strong>Ch·∫ø ƒê·ªô Xem:</strong> Khi b·∫≠t, ch·ªâ kh√≥a n√∫t Th√™m / Ghi / X√≥a<br>
                ‚ö†Ô∏è <strong>M·∫≠t Kh·∫©u:</strong> ƒê∆∞·ª£c l∆∞u v√† ƒë·ªìng b·ªô tr√™n Cloud Firebase
            </div>

            <h3 style="margin-top: 30px;">Tr·∫°ng Th√°i Hi·ªán T·∫°i</h3>
            <div class="payment-item">
                <div class="payment-name">Ch·∫ø ƒê·ªô</div>
                <div><span id="modeStatus" class="money negative">üîí Ch·ªâ Xem (B·∫≠t)</span></div>
            </div>
            <div class="payment-item">
                <div class="payment-name">ƒê·ªìng B·ªô Cloud</div>
                <div><span id="syncStatus2" class="money positive">‚úì T·ª± ƒê·ªông</span></div>
            </div>
        </div>

        <!-- Tab Backup -->
        <div id="backup" class="tab-content">
            <h2>üíæ Sao L∆∞u & ƒê·ªìng B·ªô</h2>
            <button class="btn success" onclick="toggleAutoSync()" id="autoSyncBtn">üîÑ T·ª± ƒê·ªông ƒê·ªìng B·ªô Firebase</button>
            <button class="btn" onclick="manualSaveFirebase()">üíæ L∆∞u L√™n Firebase Ngay</button>
            <button class="btn" onclick="manualLoadFirebase()">üì• T·∫£i T·ª´ Firebase</button>
            <button class="btn" onclick="exportData()">üì• T·∫£i V·ªÅ (JSON)</button>
            <button class="btn danger" onclick="clearAllData()">üóëÔ∏è X√≥a T·∫•t C·∫£</button>

            <div class="info-text" style="margin-top: 20px; background: rgba(34, 199, 90, 0.1); padding: 12px; border-radius: 8px;">
                ‚úì D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr√™n m√°y t√≠nh + Firebase Cloud<br>
                ‚úì 100% offline - kh√¥ng c·∫ßn internet<br>
                ‚úì T·ª± ƒë·ªông ƒë·ªìng b·ªô khi c√≥ thay ƒë·ªïi
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBG-6841iqN0DM-n7Bz7rbMSlAF5rqrQtU",
            authDomain: "viettri-c414e.firebaseapp.com",
            databaseURL: "https://viettri-c414e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "viettri-c414e",
            storageBucket: "viettri-c414e.firebasestorage.app",
            messagingSenderId: "149479382894",
            appId: "1:149479382894:web:9408a8cc797ef22fe42b7f"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let members = JSON.parse(localStorage.getItem('members')) || [];
        let schedules = JSON.parse(localStorage.getItem('schedules')) || [];
        let matches = JSON.parse(localStorage.getItem('matches')) || [];
        let autoSyncEnabled = true;
        let readOnlyMode = true;
        let adminPassword = localStorage.getItem('adminPassword') || 'Tayho';

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'ranking-money') updateRankingMoney();
            else if (tabName === 'ranking-skill') updateRankingSkill();
            else if (tabName === 'ranking-score') updateRankingScore();
            else if (tabName === 'payment') updatePaymentDropdown();
            else if (tabName === 'settings') updateSettingsUI();
        }

        function updateSettingsUI() {
            document.getElementById('modeStatus').textContent = readOnlyMode ? 'üîí Ch·ªâ Xem (B·∫≠t)' : '‚úèÔ∏è Ch·ªânh S·ª≠a (T·∫°m th·ªùi)';
            document.getElementById('modeStatus').className = readOnlyMode ? 'money negative' : 'money positive';
            document.getElementById('syncStatus2').textContent = '‚úì T·ª± ƒê·ªông';
            document.getElementById('syncStatus2').className = 'money positive';
        }

        function toggleReadOnlyWithPassword() {
            const pwd = prompt('Nh·∫≠p m·∫≠t kh·∫©u admin ƒë·ªÉ t·∫Øt ch·∫ø ƒë·ªô xem (5 ph√∫t):');
            if (!pwd) return;
            if (pwd !== adminPassword) {
                showNotification('M·∫≠t kh·∫©u sai!', 'error');
                return;
            }
            readOnlyMode = false;
            applyReadOnlyMode();
            updateSettingsUI();
            showNotification('‚úì Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a ƒë√£ b·∫≠t trong 5 ph√∫t', 'success');
            setTimeout(() => {
                readOnlyMode = true;
                applyReadOnlyMode();
                updateSettingsUI();
                showNotification('‚è±Ô∏è ƒê√£ quay l·∫°i ch·∫ø ƒë·ªô ch·ªâ xem', 'info');
                autoSync();
            }, 300000);
        }

        function applyReadOnlyMode() {
            // Ch·∫ø ƒë·ªô xem: ch·ªâ kh√≥a n√∫t h√†nh ƒë·ªông, KH√îNG kh√≥a select / input ng√†y
            const disableButtonsText = ['Th√™m', 'Ghi', 'X√≥a'];
            const buttons = document.querySelectorAll('.btn');

            buttons.forEach(btn => {
                const text = btn.textContent || '';
                const isAction =
                    disableButtonsText.some(t => text.includes(t)) &&
                    !text.includes('T·∫£i') && !text.includes('Firebase');
                if (isAction) {
                    btn.disabled = readOnlyMode;
                    btn.style.opacity = readOnlyMode ? '0.5' : '1';
                    btn.style.cursor = readOnlyMode ? 'not-allowed' : 'pointer';
                }
            });

            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(btn => {
                btn.disabled = readOnlyMode;
                btn.style.opacity = readOnlyMode ? '0.5' : '1';
                btn.style.cursor = readOnlyMode ? 'not-allowed' : 'pointer';
            });
        }

        function addMember() {
            const name = document.getElementById('memberName').value.trim();
            const type = document.getElementById('memberType').value;
            if (!name) {
                showNotification('Vui l√≤ng nh·∫≠p t√™n VƒêV', 'error');
                return;
            }
            if (members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                showNotification('VƒêV n√†y ƒë√£ c√≥ trong danh s√°ch', 'error');
                return;
            }
            members.push({ id: Date.now(), name, type });
            saveData();
            showNotification(`‚úì ƒê√£ th√™m VƒêV: ${name}`, 'success');
            document.getElementById('memberName').value = '';
            updateMembersList();
            updatePairSelects();
            autoSync();
        }

        function deleteMember(id) {
            if (confirm('X√≥a VƒêV n√†y?')) {
                members = members.filter(m => m.id !== id);
                saveData();
                updateMembersList();
                updatePairSelects();
                showNotification('ƒê√£ x√≥a VƒêV', 'success');
                autoSync();
            }
        }

        function updateMembersList() {
            const html = members.map(m => `
                <div class="member-item">
                    <div><div class="member-name">${m.name}<span class="member-badge ${m.type === 'guest' ? 'guest' : ''}">${m.type === 'club' ? 'Th√†nh Vi√™n' : 'Kh√°ch'}</span></div></div>
                    <button class="delete-btn" onclick="deleteMember(${m.id})">X√≥a</button>
                </div>
            `).join('') || '<div class="empty-state"><p>Ch∆∞a c√≥ th√†nh vi√™n</p></div>';
            document.getElementById('membersList').innerHTML = html;
        }

        function addSchedule() {
            const dateInput = document.getElementById('scheduleDate').value.trim();
            const note = document.getElementById('scheduleNote').value.trim();
            if (!dateInput) {
                showNotification('Vui l√≤ng nh·∫≠p ng√†y', 'error');
                return;
            }
            const dateRegex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            const match = dateInput.match(dateRegex);
            if (!match) {
                showNotification('ƒê·ªãnh d·∫°ng ng√†y kh√¥ng h·ª£p l·ªá (dd/mm/yyyy)', 'error');
                return;
            }
            const [_, day, month, year] = match;
            const date = `${year}-${month}-${day}`;
            if (schedules.some(s => s.date === date)) {
                showNotification('Ng√†y n√†y ƒë√£ c√≥ trong l·ªãch', 'error');
                return;
            }
            schedules.push({ id: Date.now(), date, note, displayDate: dateInput });
            schedules.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            showNotification('‚úì ƒê√£ th√™m ng√†y sinh ho·∫°t', 'success');
            document.getElementById('scheduleDate').value = '';
            document.getElementById('scheduleNote').value = '';
            updateScheduleList();
            updateScheduleSelects();
            autoSync();
        }

        function deleteSchedule(id) {
            if (confirm('X√≥a ng√†y sinh ho·∫°t n√†y?')) {
                schedules = schedules.filter(s => s.id !== id);
                saveData();
                updateScheduleList();
                updateScheduleSelects();
                showNotification('ƒê√£ x√≥a ng√†y sinh ho·∫°t', 'success');
                autoSync();
            }
        }

        function updateScheduleList() {
            const html = schedules.map(s => {
                const dateStr = s.displayDate || new Date(s.date).toLocaleDateString('vi-VN');
                const matchCount = matches.filter(m => m.date === s.date).length;
                return `
                    <div class="match-item">
                        <div class="match-info">
                            <div class="match-players"><strong>${dateStr}</strong></div>
                            <div class="match-score">${s.note || 'Kh√¥ng c√≥ ghi ch√∫'} ‚Ä¢ ${matchCount} tr·∫≠n</div>
                        </div>
                        <button class="delete-btn" onclick="deleteSchedule(${s.id})">X√≥a</button>
                    </div>
                `;
            }).join('') || '<div class="empty-state"><p>Ch∆∞a c√≥ l·ªãch sinh ho·∫°t</p></div>';
            document.getElementById('scheduleList').innerHTML = html;
        }

        function updateScheduleSelects() {
            const select = document.getElementById('eventDate');
            const value = select.value;
            select.innerHTML = '<option value="">-- Ch·ªçn ng√†y --</option>' +
                schedules.map(s => `<option value="${s.date}">${s.displayDate || new Date(s.date).toLocaleDateString('vi-VN')}${s.note ? ` (${s.note})` : ''}</option>`).join('');
            if (value) select.value = value;
            updatePaymentDropdown();
        }

        function updatePaymentDropdown() {
            const select = document.getElementById('paymentDate');
            const value = select.value;
            select.innerHTML = '<option value="">-- Ch·ªçn ng√†y --</option>' +
                schedules.map(s => `<option value="${s.date}">${s.displayDate || new Date(s.date).toLocaleDateString('vi-VN')}${s.note ? ` (${s.note})` : ''}</option>`).join('');
            if (value) select.value = value;
        }

        function updatePairSelects() {
            const playerNames = members.map(m => m.name);
            const selectIds = ['pair1a', 'pair1b', 'pair2a', 'pair2b'];
            selectIds.forEach(id => {
                const elem = document.getElementById(id);
                const value = elem.value;
                elem.innerHTML = '<option value="">-- Ch·ªçn --</option>' + playerNames.map(p => `<option value="${p}">${p}</option>`).join('');
                if (value) elem.value = value;
            });
        }

        function updateMatchForm() {
            if (!document.getElementById('eventDate').value) return;
        }

        function addMatch() {
            const date = document.getElementById('eventDate').value;
            const p1a = document.getElementById('pair1a').value;
            const p1b = document.getElementById('pair1b').value;
            const p2a = document.getElementById('pair2a').value;
            const p2b = document.getElementById('pair2b').value;
            const score1 = parseInt(document.getElementById('score1').value) || 0;
            const score2 = parseInt(document.getElementById('score2').value) || 0;

            if (!date) {
                showNotification('Vui l√≤ng ch·ªçn ng√†y sinh ho·∫°t', 'error');
                return;
            }
            if (!p1a || !p1b || !p2a || !p2b) {
                showNotification('Vui l√≤ng ch·ªçn ƒë·ªß 4 VƒêV', 'error');
                return;
            }
            const allPlayers = [p1a, p1b, p2a, p2b];
            if (new Set(allPlayers).size !== 4) {
                showNotification('C√°c VƒêV kh√¥ng ƒë∆∞·ª£c tr√πng nhau', 'error');
                return;
            }

            const pair1 = `${p1a} - ${p1b}`;
            const pair2 = `${p2a} - ${p2b}`;

            matches.push({
                id: Date.now(),
                date,
                pair1,
                pair2,
                score1,
                score2,
                result1: score1 > score2 ? 'win' : 'lose',
                result2: score2 > score1 ? 'win' : 'lose'
            });

            saveData();
            showNotification(`‚úì Th√™m tr·∫≠n: ${pair1} ${score1} - ${score2} ${pair2}`, 'success');
            document.getElementById('score1').value = '';
            document.getElementById('score2').value = '';
            document.getElementById('pair1a').value = '';
            document.getElementById('pair1b').value = '';
            document.getElementById('pair2a').value = '';
            document.getElementById('pair2b').value = '';
            updateMatchList();
            updatePaymentList();
            autoSync();
        }

        function updateMatchList() {
            const dateFilter = document.getElementById('eventDate').value;
            const filtered = dateFilter ? matches.filter(m => m.date === dateFilter) : matches;
            const html = filtered.slice().reverse().map(m => `
                <div class="match-item">
                    <div class="match-info">
                        <div class="match-players">${m.pair1} <strong>${m.score1}</strong> - <strong>${m.score2}</strong> ${m.pair2}</div>
                        <div class="match-score">${m.date}</div>
                    </div>
                    <button class="delete-btn" onclick="deleteMatch(${m.id})">X√≥a</button>
                </div>
            `).join('') || '<div class="empty-state"><p>Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u</p></div>';
            document.getElementById('matchList').innerHTML = html;
        }

        function deleteMatch(id) {
            if (confirm('X√≥a tr·∫≠n ƒë·∫•u n√†y?')) {
                matches = matches.filter(m => m.id !== id);
                saveData();
                updateMatchList();
                updatePaymentList();
                showNotification('ƒê√£ x√≥a tr·∫≠n ƒë·∫•u', 'success');
                autoSync();
            }
        }

        function updatePaymentList() {
            const date = document.getElementById('paymentDate').value;
            if (!date) {
                document.getElementById('paymentList').innerHTML = '<div class="empty-state"><p>Vui l√≤ng ch·ªçn ng√†y</p></div>';
                return;
            }

            const dayMatches = matches.filter(m => m.date === date);
            const playerMoney = {};

            dayMatches.forEach(m => {
                const [p1a, p1b] = m.pair1.split(' - ').map(x => x.trim());
                const [p2a, p2b] = m.pair2.split(' - ').map(x => x.trim());

                if (m.result1 === 'win') {
                    playerMoney[p1a] = (playerMoney[p1a] || 0) + 50;
                    playerMoney[p1b] = (playerMoney[p1b] || 0) + 50;
                    playerMoney[p2a] = (playerMoney[p2a] || 0) - 50;
                    playerMoney[p2b] = (playerMoney[p2b] || 0) - 50;
                } else {
                    playerMoney[p2a] = (playerMoney[p2a] || 0) + 50;
                    playerMoney[p2b] = (playerMoney[p2b] || 0) + 50;
                    playerMoney[p1a] = (playerMoney[p1a] || 0) - 50;
                    playerMoney[p1b] = (playerMoney[p1b] || 0) - 50;
                }
            });

            if (Object.keys(playerMoney).length === 0) {
                document.getElementById('paymentList').innerHTML = '<div class="empty-state"><p>Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u ng√†y n√†y</p></div>';
                return;
            }

            const sorted = Object.entries(playerMoney).sort((a, b) => a[1] - b[1]);
            const total = Object.values(playerMoney).reduce((a, b) => a + b, 0);

            let html = `<div class="payment-date-header">üìÖ ${new Date(date).toLocaleDateString('vi-VN')}</div>`;
            html += sorted.map(([name, amount]) => `
                <div class="payment-item">
                    <div class="payment-name">${name}</div>
                    <div><span class="money ${amount < 0 ? 'negative' : 'positive'}">${amount < 0 ? '-' : '+'}${Math.abs(amount)}k</span></div>
                </div>
            `).join('');
            html += `<div class="total-payment"><div class="total-payment-label">T·ªïng C·ªông</div><div class="total-payment-value">${total >= 0 ? '+' : ''}${total}k</div></div>`;

            document.getElementById('paymentList').innerHTML = html;
        }

        function updateRankingMoney() {
            const currentYear = new Date().getFullYear();
            const playerMoney = {};

            matches.forEach(m => {
                if (new Date(m.date).getFullYear() !== currentYear) return;
                const [p1a, p1b] = m.pair1.split(' - ').map(x => x.trim());
                const [p2a, p2b] = m.pair2.split(' - ').map(x => x.trim());

                if (m.result1 === 'win') {
                    playerMoney[p1a] = (playerMoney[p1a] || { money: 0, matches: 0 });
                    playerMoney[p1b] = (playerMoney[p1b] || { money: 0, matches: 0 });
                    playerMoney[p1a].money += 50;
                    playerMoney[p1b].money += 50;
                    playerMoney[p1a].matches++;
                    playerMoney[p1b].matches++;
                    playerMoney[p2a] = (playerMoney[p2a] || { money: 0, matches: 0 });
                    playerMoney[p2b] = (playerMoney[p2b] || { money: 0, matches: 0 });
                    playerMoney[p2a].money -= 50;
                    playerMoney[p2b].money -= 50;
                    playerMoney[p2a].matches++;
                    playerMoney[p2b].matches++;
                } else {
                    playerMoney[p2a] = (playerMoney[p2a] || { money: 0, matches: 0 });
                    playerMoney[p2b] = (playerMoney[p2b] || { money: 0, matches: 0 });
                    playerMoney[p2a].money += 50;
                    playerMoney[p2b].money += 50;
                    playerMoney[p2a].matches++;
                    playerMoney[p2b].matches++;
                    playerMoney[p1a] = (playerMoney[p1a] || { money: 0, matches: 0 });
                    playerMoney[p1b] = (playerMoney[p1b] || { money: 0, matches: 0 });
                    playerMoney[p1a].money -= 50;
                    playerMoney[p1b].money -= 50;
                    playerMoney[p1a].matches++;
                    playerMoney[p1b].matches++;
                }
            });

            const sorted = Object.entries(playerMoney).sort((a, b) => b[1].money - a[1].money);
            const tbody = document.getElementById('rankingMoneyBody');

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }

            tbody.innerHTML = sorted.map(([name, data], i) => `
                <tr>
                    <td><span class="rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}">${i + 1}</span></td>
                    <td>${name}</td>
                    <td>${data.matches}</td>
                    <td><span class="money ${data.money >= 0 ? 'positive' : 'negative'}">${data.money >= 0 ? '+' : ''}${data.money}k</span></td>
                </tr>
            `).join('');
        }

        function updateRankingSkill() {
            const playerStats = {};

            matches.forEach(m => {
                const [p1a, p1b] = m.pair1.split(' - ').map(x => x.trim());
                const [p2a, p2b] = m.pair2.split(' - ').map(x => x.trim());

                [p1a, p1b, p2a, p2b].forEach(name => {
                    if (!playerStats[name]) playerStats[name] = { wins: 0, matches: 0 };
                    playerStats[name].matches++;
                    if ((m.pair1.includes(name) && m.result1 === 'win') || (m.pair2.includes(name) && m.result2 === 'win')) {
                        playerStats[name].wins++;
                    }
                });
            });

            const filtered = Object.entries(playerStats)
                .filter(([_, s]) => s.matches >= 5)
                .sort((a, b) => (b[1].wins / b[1].matches) - (a[1].wins / a[1].matches));

            const tbody = document.getElementById('rankingSkillBody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Ch∆∞a c√≥ VƒêV ‚â•5 tr·∫≠n</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(([name, stats], i) => {
                const wr = ((stats.wins / stats.matches) * 100).toFixed(1);
                return `
                    <tr>
                        <td><span class="rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}">${i + 1}</span></td>
                        <td>${name}</td>
                        <td>${stats.matches}</td>
                        <td>${wr}%</td>
                    </tr>
                `;
            }).join('');
        }

        function updateRankingScore() {
            const playerScore = {};

            matches.forEach(m => {
                const [p1a, p1b] = m.pair1.split(' - ').map(x => x.trim());
                const [p2a, p2b] = m.pair2.split(' - ').map(x => x.trim());

                if (m.result1 === 'win') {
                    playerScore[p1a] = (playerScore[p1a] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 });
                    playerScore[p1b] = (playerScore[p1b] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 });
                    playerScore[p1a].score += 1;
                    playerScore[p1b].score += 1;
                    playerScore[p1a].wins++;
                    playerScore[p1b].wins++;
                    playerScore[p1a].totalScore1 += m.score1;
                    playerScore[p1b].totalScore1 += m.score1;
                    playerScore[p1a].totalScore2 += m.score2;
                    playerScore[p1b].totalScore2 += m.score2;
                    playerScore[p2a] = (playerScore[p2a] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 });
                    playerScore[p2b] = (playerScore[p2b] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 });
                    playerScore[p2a].score -= 1;
                    playerScore[p2b].score -= 1;
                    playerScore[p2a].losses++;
                    playerScore[p2b].losses++;
                    playerScore[p2a].totalScore1 += m.score2;
                    playerScore[p2b].totalScore1 += m.score2;
                    playerScore[p2a].totalScore2 += m.score1;
                    playerScore[p2b].totalScore2 += m.score1;
                } else {
                    playerScore[p2a] = (playerScore[p2a] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 });
                    playerScore[p2b] = (playerScore[p2b] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 });
                    playerScore[p2a].score += 1;
                    playerScore[p2b].score += 1;
                    playerScore[p2a].wins++;
                    playerScore[p2b].wins++;
                    playerScore[p2a].totalScore1 += m.score2;
                    playerScore[p2b].totalScore1 += m.score2;
                    playerScore[p2a].totalScore2 += m.score1;
                    playerScore[p2b].totalScore2 += m.score1;
                    playerScore[p1a] = (playerScore[p1a] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 });
                    playerScore[p1b] = (playerScore[p1b] || { score: 0, wins: 0, losses: 0, totalScore1: 0, totalScore2: 0 });
                    playerScore[p1a].score -= 1;
                    playerScore[p1b].score -= 1;
                    playerScore[p1a].losses++;
                    playerScore[p1b].losses++;
                    playerScore[p1a].totalScore1 += m.score1;
                    playerScore[p1b].totalScore1 += m.score1;
                    playerScore[p1a].totalScore2 += m.score2;
                    playerScore[p1b].totalScore2 += m.score2;
                }
            });

            const sorted = Object.entries(playerScore).sort((a, b) => b[1].score - a[1].score);
            const tbody = document.getElementById('rankingScoreBody');

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }

            tbody.innerHTML = sorted.map(([name, data], i) => {
                const scoreDiff = data.totalScore1 - data.totalScore2;
                return `
                    <tr>
                        <td><span class="rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}">${i + 1}</span></td>
                        <td>${name}</td>
                        <td>${data.wins}/${data.losses}</td>
                        <td><span class="money ${data.score >= 0 ? 'positive' : 'negative'}">${data.score >= 0 ? '+' : ''}${data.score}ƒë</span></td>
                        <td><span class="money ${scoreDiff >= 0 ? 'positive' : 'negative'}">${scoreDiff >= 0 ? '+' : ''}${scoreDiff}</span></td>
                    </tr>
                `;
            }).join('');
        }

        async function manualSaveFirebase() {
            setSyncLoading(true);
            try {
                await set(ref(database, 'VietTri'), { 
                    members, 
                    schedules, 
                    matches, 
                    adminPassword,
                    readOnlyMode: true,
                    lastSync: new Date().toISOString() 
                });
                setSyncLoading(false);
                showNotification('‚úÖ L∆∞u Firebase th√†nh c√¥ng!', 'success');
            } catch (e) {
                setSyncLoading(false);
                showNotification('‚ùå L∆∞u th·∫•t b·∫°i', 'error');
            }
        }

        async function manualLoadFirebase() {
            setSyncLoading(true);
            try {
                const snapshot = await get(ref(database, 'VietTri'));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    members = data.members || [];
                    schedules = data.schedules || [];
                    matches = data.matches || [];
                    adminPassword = data.adminPassword || 'Tayho';
                    saveData();
                    localStorage.setItem('adminPassword', adminPassword);
                    updateMembersList();
                    updatePairSelects();
                    updateScheduleList();
                    updateScheduleSelects();
                    updateMatchList();
                    applyReadOnlyMode();
                    updateSettingsUI();
                    setSyncLoading(false);
                    showNotification('‚úÖ T·∫£i Firebase th√†nh c√¥ng!', 'success');
                } else {
                    setSyncLoading(false);
                    showNotification('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu', 'info');
                }
            } catch (e) {
                setSyncLoading(false);
                showNotification('‚ùå T·∫£i th·∫•t b·∫°i', 'error');
            }
        }

        async function autoSync() {
            try {
                await set(ref(database, 'VietTri'), { 
                    members, 
                    schedules, 
                    matches, 
                    adminPassword,
                    readOnlyMode: true,
                    lastSync: new Date().toISOString() 
                });
            } catch (e) {}
        }

        function setSyncLoading(loading) {
            const status = document.getElementById('syncStatus');
            const text = document.getElementById('syncText');
            if (loading) {
                status.classList.add('loading');
                text.textContent = 'ƒêang ƒë·ªìng b·ªô...';
            } else {
                status.classList.remove('loading');
                text.textContent = 'S·∫µn s√†ng ƒë·ªìng b·ªô';
            }
        }

        window.toggleAutoSync = function() {
            showNotification('‚úÖ T·ª± ƒë·ªông ƒë·ªìng b·ªô lu√¥n b·∫≠t', 'info');
        };

        window.toggleReadOnlyWithPassword = toggleReadOnlyWithPassword;
        window.manualSaveFirebase = manualSaveFirebase;
        window.manualLoadFirebase = manualLoadFirebase;
        window.switchTab = switchTab;
        window.addMember = addMember;
        window.deleteMember = deleteMember;
        window.addSchedule = addSchedule;
        window.deleteSchedule = deleteSchedule;
        window.updateMatchForm = updateMatchForm;
        window.addMatch = addMatch;
        window.deleteMatch = deleteMatch;
        window.updatePaymentList = updatePaymentList;

        window.exportData = function() {
            const data = JSON.stringify({ members, schedules, matches }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'VietTri-data.json';
            a.click();
            showNotification('‚úÖ T·∫£i v·ªÅ th√†nh c√¥ng!', 'success');
        };

        window.clearAllData = function() {
            if (!confirm('‚ö†Ô∏è X√≥a t·∫•t c·∫£? (kh√¥ng th·ªÉ ho√†n t√°c)')) return;
            members = [];
            schedules = [];
            matches = [];
            saveData();
            updateMembersList();
            updateScheduleList();
            updateMatchList();
            document.getElementById('paymentList').innerHTML = '';
            document.getElementById('rankingMoneyBody').innerHTML = '<tr><td colspan="4" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            document.getElementById('rankingSkillBody').innerHTML = '<tr><td colspan="4" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            document.getElementById('rankingScoreBody').innerHTML = '<tr><td colspan="5" class="empty-state">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
            showNotification('ƒê√£ x√≥a t·∫•t c·∫£', 'success');
            autoSync();
        };

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function saveData() {
            localStorage.setItem('members', JSON.stringify(members));
            localStorage.setItem('schedules', JSON.stringify(schedules));
            localStorage.setItem('matches', JSON.stringify(matches));
        }

        // Init
        updateMembersList();
        updatePairSelects();
        updateScheduleList();
        updateScheduleSelects();
        updateMatchList();
        document.getElementById('autoSyncBtn').textContent = '‚úÖ T·ª± ƒê·ªông ƒê·ªìng B·ªô (B·∫¨T)';
        applyReadOnlyMode();
        updateSettingsUI();

        window.addEventListener('load', () => {
            setTimeout(() => manualLoadFirebase(), 500);
        });
    </script>
</body>
</html>
